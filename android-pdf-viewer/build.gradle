apply plugin: 'com.android.library'

ext {
    bintrayRepo = 'maven'
    bintrayName = 'android-pdf-viewer'

    publishedGroupId = 'com.github.MrWangChong'
    libraryName = 'AndroidPdfViewer'
    artifact = 'android-pdf-viewer'

    libraryDescription = 'Android view for displaying PDFs rendered with PdfiumAndroid'

    siteUrl = 'https://github.com/MrWangChong/AndroidPdfViewer'
    gitUrl = 'https://github.com/MrWangChong/AndroidPdfViewer.git'

    libraryVersion = '3.2.0-final.1'

    developerId = 'MrWangChong'
    developerName = 'MrWangChong'
    developerEmail = '1054917071@qq.com'

    licenseName = 'The Apache Software License, Version 2.0'
    licenseUrl = 'http://www.apache.org/licenses/LICENSE-2.0.txt'
    allLicenses = ["Apache-2.0"]
}

android {
    namespace 'com.github.barteksc.pdfviewer'
    compileSdkVersion 36

    defaultConfig {
        minSdkVersion 16
        targetSdkVersion 36
    }

    compileOptions {
        sourceCompatibility JavaVersion.VERSION_17
        targetCompatibility JavaVersion.VERSION_17
    }

    // Configure packaging for 16 KB page size compatibility.
    // Native libraries should be stored uncompressed and page-aligned in the APK.
    packagingOptions {
        jniLibs {
            // Setting to false ensures native libraries are stored uncompressed and aligned.
            // This is the default for AGP 3.6+ but explicitly set for clarity.
            useLegacyPackaging false
        }
    }

    // Enable 16 KB page size support for native libraries
    ndkVersion "28.0.12433566"  // Use NDK r28+ for 16 KB support

    // Disable lint for now to focus on 16 KB compatibility
    lint {
        abortOnError false
    }

}

// build.gradle (åœ¨ android { ... } å—ä¹‹å)

// 1. å¿…é¡»åº”ç”¨ maven-publish æ’ä»¶
apply plugin: 'maven-publish'

task sourcesJar(type: Jar) {
    // ğŸš© ç§»é™¤æ‰€æœ‰ classifier èµ‹å€¼
    from android.sourceSets.main.java.srcDirs
}

//task javadoc(type: Javadoc) {
//    // æ˜ç¡®æŒ‡å®šæºæ–‡ä»¶é›†åˆ
//    source = android.sourceSets.main.java.srcDirs
//
//    // ğŸš© å…³é”®ä¿®å¤ï¼šåˆ‡æ¢åˆ°æœ€å¤è€ã€æœ€é€šç”¨çš„å‘å¸ƒé…ç½® 'archives'
//    // è¿™æ˜¯åœ¨æ‰€æœ‰ç°ä»£é…ç½®éƒ½å¤±è´¥æ—¶ï¼Œç”¨äºè·å– Classpath çš„ç»ˆæå…¼å®¹æ–¹æ¡ˆã€‚
//    classpath += project.configurations.getByName("archives")
//
//    // å¿½ç•¥ Javadoc è­¦å‘Š
//    options.addStringOption('Xdoclint:none', '-quiet')
//    options.addStringOption('encoding', 'UTF-8')
//}
//
//task javadocJar(type: Jar, dependsOn: javadoc) {
//    // ğŸš© ç§»é™¤æ‰€æœ‰ classifier èµ‹å€¼
//    from javadoc.destinationDir
//}

// ----------------------------------------------------
// 3. é…ç½® publishing å—
// ----------------------------------------------------
publishing {
    // 3.1. é…ç½®å‘å¸ƒçš„ GAV (Group, Artifact, Version)
    publications {
        // ä½¿ç”¨ release æ„å»ºå˜ä½“ä½œä¸º Maven publication çš„æº
        maven(MavenPublication) {
            groupId = publishedGroupId
            artifactId = artifact
            version = libraryVersion
            // ç¡®ä¿ artifact æ˜¯ç›´æ¥çš„æ–‡ä»¶è·¯å¾„ï¼Œæ²¡æœ‰ builtBy
            artifact("$buildDir/outputs/aar/${project.name}-release.aar")
            // sourcesJar ä¹Ÿåº”è¯¥ç›´æ¥å¼•ç”¨
            artifact sourcesJar
//            artifact javadocJar
            // é…ç½® POM æ–‡ä»¶çš„å…ƒæ•°æ®ï¼ˆå¯é€‰ï¼Œä½†æ¨èï¼‰
            pom {
                name = libraryName
                description = libraryDescription
                url = siteUrl
                licenses {
                    license {
                        name = licenseName
                        url = licenseUrl
                    }
                }
                developers {
                    developer {
                        id = developerId
                        name = developerName
                        email = developerEmail
                    }
                }
                scm {
                    connection = gitUrl
                    developerConnection = gitUrl
                    url = siteUrl
                }
            }
        }
    }
}

// ğŸš© ç»ˆæä¿®å¤ï¼šä½¿ç”¨ afterEvaluate + Groovy é—­åŒ…çš„æ—§ç‰ˆè¯­æ³•é…ç½®ä¾èµ–
afterEvaluate {
    // 1. ä½¿ç”¨ tasks.getByName è·å–ä»»åŠ¡å¯¹è±¡ï¼Œè€Œä¸æ˜¯ Provider
    def publishTask = tasks.getByName("publishMavenPublicationToMavenLocal")

    // 2. åœ¨è·å–åˆ°çš„ä»»åŠ¡å¯¹è±¡ä¸Šç›´æ¥è°ƒç”¨ dependsOnï¼Œå¹¶ä½¿ç”¨ tasks.getByName å¼•ç”¨ä¾èµ–ä»»åŠ¡
    publishTask.dependsOn(
            // æˆ‘ä»¬ç¡®è®¤ JitPack è¯†åˆ« 'bundleReleaseAar'
            tasks.getByName('bundleReleaseAar'),
            tasks.getByName('sourcesJar')
    )

    // âš ï¸ å¦‚æœæ‚¨æœ¬åœ°ç¼–è¯‘ bundleReleaseAar ä»ç„¶æŠ¥é”™ "Task not found"ï¼Œè¯·å°è¯•ä½¿ç”¨ bundleRelease æ›¿æ¢ä¸Šé¢çš„ bundleReleaseAarã€‚
    // publishTask.dependsOn(
    //     tasks.getByName('bundleRelease'),
    //     tasks.getByName('sourcesJar')
    // )
}

dependencies {
    implementation 'androidx.core:core:1.17.0'
    api 'io.github.oothp:pdfium-android:1.9.5-beta01'
}

